# F37 — Enforce Workflow Principles in Templates

## Tasks

### T01 — Add task-file existence guard to start_task.md
**Status**: done
**Description**: At the top of `start_task.md` (before any implementation instructions), add an explicit guard: if the injected `{{tasks}}` value starts with "(not yet available:", output "Error: No task file for {{feature_id}}. Run `/tasks-gen {{feature_id}}` first." and stop. This enforces Principle 3 for `/task-start`.

### T02 — Add task-file existence guard to next_task.md
**Status**: done
**Description**: Same guard as T01 but in `next_task.md`. The spec already requires `/task-next` to "exit with a clear error message" if no task files exist (spec line ~98). Add the check: if `{{tasks}}` starts with "(not yet available:", output "Error: No task file found. Run `/tasks-gen` first." and stop.

### T03 — Add task-file existence guard to run_all_tasks.md
**Status**: done
**Description**: Same guard as T01 but in `run_all_tasks.md`. If `{{tasks}}` starts with "(not yet available:", output "Error: No task file for {{feature_id}}. Run `/tasks-gen {{feature_id}}` first." and stop.

### T04 — Add feature-existence guard to gen_tasks.md
**Status**: done
**Description**: At the top of `gen_tasks.md`, add a guard: if `{{feature}}` starts with "(not yet available:" or the feature ID is not found, output "Error: Feature {{feature_id}} not found in features.md. Run `/features-gen` or `/features-update` first." and stop. This enforces Principle 3 for `/tasks-gen`.

### T05 — Fix milestone.md idempotency: skip archive if already done
**Status**: done
**Description**: In `milestone.md`, update the archive instruction to check both locations: "If `.j2/tasks/{{feature_id}}.md` exists, move it to `.j2/tasks/done/{{feature_id}}.md`. If it is already in `.j2/tasks/done/`, skip this step." This makes `/milestone` safe to re-run.

### T06 — Fix checkpoint.md idempotency: skip commit if nothing changed
**Status**: done
**Description**: In `checkpoint.md`, add a check before the commit step: run `git diff --cached --stat`. If the output is empty (nothing staged), skip the commit and report "No changes since last checkpoint." This prevents a git error when `/checkpoint` is run twice without intervening changes.

### T07 — Write tests verifying the new guards are present in templates
**Status**: done
**Description**: In `tests/test_runner_commands.py`, add four tests: `test_start_task_template_has_missing_file_guard`, `test_next_task_template_has_missing_file_guard`, `test_run_all_tasks_template_has_missing_file_guard`, and `test_gen_tasks_template_has_feature_guard`. Each reads the relevant template and asserts the guard text is present (keyword checks like "not yet available" or "Error:").
